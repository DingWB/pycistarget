<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pycistarget.utils &mdash; pycistarget 1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> pycistarget
          </a>
              <div class="version">
                1.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">pycisTarget methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../motif_table.html">SCENIC+ motif collection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pycistarget</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>pycistarget.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pycistarget.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">ctxcore.genesig</span> <span class="k">import</span> <span class="n">Regulon</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pyranges</span> <span class="k">as</span> <span class="nn">pr</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="k">import</span> <span class="n">Iterable</span>

<div class="viewcode-block" id="coord_to_region_names"><a class="viewcode-back" href="../../api.html#pycistarget.utils.coord_to_region_names">[docs]</a><span class="k">def</span> <span class="nf">coord_to_region_names</span><span class="p">(</span><span class="n">coord</span><span class="p">:</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert coordinates to region names (UCSC format)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">):</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">as_df</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">coord</span><span class="p">[</span><span class="s1">&#39;Chromosome&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">coord</span><span class="p">[</span><span class="s1">&#39;Start&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="n">coord</span><span class="p">[</span><span class="s1">&#39;End&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span></div>

<div class="viewcode-block" id="region_names_to_coordinates"><a class="viewcode-back" href="../../api.html#pycistarget.utils.region_names_to_coordinates">[docs]</a><span class="k">def</span> <span class="nf">region_names_to_coordinates</span><span class="p">(</span><span class="n">region_names</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert region names (UCSC format) to coordinates (pd.DataFrame)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">chrom</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">region_names</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">])</span>
    <span class="n">coor</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">region_names</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coor</span><span class="p">])</span>
    <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">coor</span><span class="p">])</span>
    <span class="n">regiondf</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">regiondf</span><span class="o">.</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">region_names</span> <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">regiondf</span><span class="o">.</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Chromosome&#39;</span><span class="p">,</span> <span class="s1">&#39;Start&#39;</span><span class="p">,</span> <span class="s1">&#39;End&#39;</span><span class="p">]</span>
    <span class="k">return</span><span class="p">(</span><span class="n">regiondf</span><span class="p">)</span></div>

<div class="viewcode-block" id="region_sets_to_signature"><a class="viewcode-back" href="../../api.html#pycistarget.utils.region_sets_to_signature">[docs]</a><span class="k">def</span> <span class="nf">region_sets_to_signature</span><span class="p">(</span><span class="n">region_set</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
                             <span class="n">region_set_name</span><span class="p">:</span><span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a gene signature object from a dict of PyRanges objects</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    pr_region_set: </span>
<span class="sd">        PyRanges object to be converted in genesignature object</span>
<span class="sd">    region_set_name:</span>
<span class="sd">        Name of the regions set</span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ---------</span>
<span class="sd">        Gene signature object of input region dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">region_set</span><span class="p">))</span>
    <span class="n">regions_name</span> <span class="o">=</span> <span class="n">region_set</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">Regulon</span><span class="p">(</span>
                    <span class="n">name</span>                 <span class="o">=</span> <span class="n">region_set_name</span><span class="p">,</span>
                    <span class="n">gene2weight</span>          <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">regions_name</span><span class="p">,</span> <span class="n">weights</span><span class="p">)),</span>
                    <span class="n">transcription_factor</span> <span class="o">=</span> <span class="n">region_set_name</span><span class="p">,</span>
                    <span class="n">gene2occurrence</span>      <span class="o">=</span> <span class="p">[])</span>
    
    <span class="k">return</span> <span class="n">signature</span></div>
    
<span class="n">ssl</span><span class="o">.</span><span class="n">_create_default_https_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">_create_unverified_context</span>

<div class="viewcode-block" id="load_motif_annotations"><a class="viewcode-back" href="../../api.html#pycistarget.utils.load_motif_annotations">[docs]</a><span class="k">def</span> <span class="nf">load_motif_annotations</span><span class="p">(</span><span class="n">specie</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                           <span class="n">version</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;v9&#39;</span><span class="p">,</span>
                           <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">column_names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;#motif_id&#39;</span><span class="p">,</span> <span class="s1">&#39;gene_name&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;motif_similarity_qvalue&#39;</span><span class="p">,</span> <span class="s1">&#39;orthologous_identity&#39;</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">),</span>
                           <span class="n">motif_similarity_fdr</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
                           <span class="n">orthologous_identity_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load motif annotations from a motif2TF snapshot.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ---------</span>
<span class="sd">    specie:</span>
<span class="sd">        Specie to retrieve annotations for.</span>
<span class="sd">    version:</span>
<span class="sd">        Motif collection version.</span>
<span class="sd">    fname: </span>
<span class="sd">        The snapshot taken from motif2TF.</span>
<span class="sd">    column_names: </span>
<span class="sd">        The names of the columns in the snapshot to load.</span>
<span class="sd">    motif_similarity_fdr: </span>
<span class="sd">        The maximum False Discovery Rate to find factor annotations for enriched motifs.</span>
<span class="sd">    orthologuous_identity_threshold: </span>
<span class="sd">        The minimum orthologuous identity to find factor annotations for enriched motifs.</span>
<span class="sd">    </span>
<span class="sd">    Return</span>
<span class="sd">    ---------</span>
<span class="sd">        A dataframe with motif annotations for each motif</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Create a MultiIndex for the index combining unique gene name and motif ID. This should facilitate</span>
    <span class="c1"># later merging.</span>
    <span class="k">if</span> <span class="n">fname</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">specie</span> <span class="o">==</span> <span class="s1">&#39;mus_musculus&#39;</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mgi&#39;</span>
        <span class="k">elif</span> <span class="n">specie</span> <span class="o">==</span> <span class="s1">&#39;homo_sapiens&#39;</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hgnc&#39;</span>
        <span class="k">elif</span> <span class="n">specie</span> <span class="o">==</span> <span class="s1">&#39;drosophila_melanogaster&#39;</span><span class="p">:</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;flybase&#39;</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;https://resources.aertslab.org/cistarget/motif2tf/motifs-&#39;</span><span class="o">+</span><span class="n">version</span><span class="o">+</span><span class="s1">&#39;-nr.&#39;</span><span class="o">+</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;-m0.001-o0.0.tbl&#39;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="n">column_names</span><span class="p">)</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;#motif_id&#39;</span><span class="p">:</span><span class="s2">&quot;MotifID&quot;</span><span class="p">,</span>
                       <span class="s1">&#39;gene_name&#39;</span><span class="p">:</span><span class="s2">&quot;TF&quot;</span><span class="p">,</span>
                       <span class="s1">&#39;motif_similarity_qvalue&#39;</span><span class="p">:</span> <span class="s2">&quot;MotifSimilarityQvalue&quot;</span><span class="p">,</span>
                       <span class="s1">&#39;orthologous_identity&#39;</span><span class="p">:</span> <span class="s2">&quot;OrthologousIdentity&quot;</span><span class="p">,</span>
                       <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="s2">&quot;Annotation&quot;</span> <span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;MotifSimilarityQvalue&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">motif_similarity_fdr</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;OrthologousIdentity&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">orthologous_identity_threshold</span><span class="p">)]</span>
    
    <span class="c1"># Direct annotation</span>
    <span class="n">df_direct_annot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;gene is directly annotated&#39;</span><span class="p">]</span>
    <span class="n">df_direct_annot</span> <span class="o">=</span> <span class="n">df_direct_annot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;MotifID&#39;</span><span class="p">])[</span><span class="s1">&#39;TF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">df_direct_annot</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_direct_annot</span><span class="p">[</span><span class="s1">&#39;MotifID&#39;</span><span class="p">]</span>
    <span class="n">df_direct_annot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df_direct_annot</span><span class="p">[</span><span class="s1">&#39;TF&#39;</span><span class="p">])</span>
    <span class="n">df_direct_annot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">]</span>
    <span class="c1"># Indirect annotation - by motif similarity</span>
    <span class="n">motif_similarity_annot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;similar&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;orthologous&#39;</span><span class="p">)]</span>
    <span class="n">motif_similarity_annot</span> <span class="o">=</span> <span class="n">motif_similarity_annot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;MotifID&#39;</span><span class="p">])[</span><span class="s1">&#39;TF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">motif_similarity_annot</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span>  <span class="n">motif_similarity_annot</span><span class="p">[</span><span class="s1">&#39;MotifID&#39;</span><span class="p">]</span>
    <span class="n">motif_similarity_annot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">motif_similarity_annot</span><span class="p">[</span><span class="s1">&#39;TF&#39;</span><span class="p">])</span>
    <span class="n">motif_similarity_annot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Motif_similarity_annot&#39;</span><span class="p">]</span>
    <span class="c1"># Indirect annotation - by orthology</span>
    <span class="n">orthology_annot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;similar&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;orthologous&#39;</span><span class="p">)]</span>
    <span class="n">orthology_annot</span> <span class="o">=</span> <span class="n">orthology_annot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;MotifID&#39;</span><span class="p">])[</span><span class="s1">&#39;TF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">orthology_annot</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">orthology_annot</span><span class="p">[</span><span class="s1">&#39;MotifID&#39;</span><span class="p">]</span>
    <span class="n">orthology_annot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">orthology_annot</span><span class="p">[</span><span class="s1">&#39;TF&#39;</span><span class="p">])</span>
    <span class="n">orthology_annot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Orthology_annot&#39;</span><span class="p">]</span>
    <span class="c1"># Indirect annotation - by orthology</span>
    <span class="n">motif_similarity_and_orthology_annot</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;similar&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Annotation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;orthologous&#39;</span><span class="p">)]</span>
    <span class="n">motif_similarity_and_orthology_annot</span> <span class="o">=</span> <span class="n">motif_similarity_and_orthology_annot</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;MotifID&#39;</span><span class="p">])[</span><span class="s1">&#39;TF&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">motif_similarity_and_orthology_annot</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">motif_similarity_and_orthology_annot</span><span class="p">[</span><span class="s1">&#39;MotifID&#39;</span><span class="p">]</span>
    <span class="n">motif_similarity_and_orthology_annot</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">motif_similarity_and_orthology_annot</span><span class="p">[</span><span class="s1">&#39;TF&#39;</span><span class="p">])</span>
    <span class="n">motif_similarity_and_orthology_annot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Motif_similarity_and_Orthology_annot&#39;</span><span class="p">]</span>
    <span class="c1"># Combine</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_direct_annot</span><span class="p">,</span> <span class="n">motif_similarity_annot</span><span class="p">,</span> <span class="n">orthology_annot</span><span class="p">,</span> <span class="n">motif_similarity_and_orthology_annot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>
    
       
<span class="c1"># Only implemented for Homer motif at the moment, but we can easily adapt it for other type of motifs as long as we</span>
<span class="c1"># write the corresponding conversion to meme </span>
<div class="viewcode-block" id="tomtom"><a class="viewcode-back" href="../../api.html#pycistarget.utils.tomtom">[docs]</a><span class="k">def</span> <span class="nf">tomtom</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
          <span class="n">meme_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
          <span class="n">meme_collection_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run tomtom for Homer motif annotation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">homer2meme</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">)</span>
    <span class="n">meme_motif_path</span> <span class="o">=</span> <span class="n">homer_motif_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.motif&#39;</span><span class="p">,</span> <span class="s1">&#39;.meme&#39;</span><span class="p">)</span>
    <span class="n">motif_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">meme_motif_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">),</span> <span class="s1">&#39;tomtom&#39;</span><span class="p">,</span> <span class="n">motif_name</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">meme_path</span><span class="p">,</span> <span class="s1">&#39;tomtom&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; -thresh 0.3 -oc </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">%</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">),</span> <span class="s1">&#39;tomtom&#39;</span><span class="p">,</span> <span class="n">motif_name</span><span class="p">),</span> <span class="n">meme_motif_path</span><span class="p">,</span> <span class="n">meme_collection_path</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;command &#39;</span><span class="si">{}</span><span class="s2">&#39; return with error (code </span><span class="si">{}</span><span class="s2">): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">cmd</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">output</span><span class="p">))</span>
    <span class="n">tomtom_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">),</span> <span class="s1">&#39;tomtom&#39;</span><span class="p">,</span> <span class="n">motif_name</span><span class="p">,</span> <span class="s1">&#39;tomtom.tsv&#39;</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tomtom_results</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">tomtom_results</span> <span class="o">=</span> <span class="n">tomtom_results</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;E-value&#39;</span><span class="p">])</span>
        <span class="n">homer_motif_name</span> <span class="o">=</span> <span class="n">tomtom_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">homer_motif_name</span> <span class="o">=</span> <span class="n">homer_motif_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;BestGuess:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">best_match_motif_name</span> <span class="o">=</span> <span class="n">tomtom_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">evalue</span> <span class="o">=</span> <span class="n">tomtom_results</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">homer_motif_name</span><span class="p">,</span> <span class="n">best_match_motif_name</span><span class="p">,</span> <span class="n">evalue</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Best Match/Details&#39;</span><span class="p">,</span> <span class="s1">&#39;Best Match/Tomtom&#39;</span><span class="p">,</span> <span class="s1">&#39;E-value/Tomtom&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="homer2meme"><a class="viewcode-back" href="../../api.html#pycistarget.utils.homer2meme">[docs]</a><span class="k">def</span> <span class="nf">homer2meme</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert Homer motifs to meme format</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.motif&#39;</span><span class="p">,</span> <span class="s1">&#39;.meme&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">homer_motif_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
    <span class="n">motif_name</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">motif_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;MEME version 4.4</span><span class="se">\n\n</span><span class="s1">ALPHABET= ACGT</span><span class="se">\n\n</span><span class="s1">strands: + -</span><span class="se">\n\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;Background letter frequencies (from uniform background):</span><span class="se">\n</span><span class="s1">A 0.25000 C 0.25000 G 0.25000 T 0.25000</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                   <span class="s1">&#39;MOTIF &#39;</span><span class="o">+</span> <span class="n">motif_name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="n">motif_id</span>  <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;letter-probability matrix: nsites= 20 alength= 4 w= &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; E= 0 </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;  &#39;</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">out_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="get_TF_list"><a class="viewcode-back" href="../../api.html#pycistarget.utils.get_TF_list">[docs]</a><span class="k">def</span> <span class="nf">get_TF_list</span><span class="p">(</span><span class="n">motif_enrichment_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
               <span class="n">annotation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Orthology_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_and_Orthology_annot&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get TFs from motif enrichment tables</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tf_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">motif_enrichment_table</span><span class="p">:</span>
            <span class="n">tfs</span> <span class="o">=</span> <span class="n">motif_enrichment_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">tfs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">tfs</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;nan&#39;</span><span class="p">]</span>
            <span class="n">tfs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">element</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">tfs</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)))]))</span>
            <span class="n">tf_list</span> <span class="o">=</span> <span class="n">tf_list</span> <span class="o">+</span> <span class="n">tfs</span>
            
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tf_list</span><span class="p">))</span></div>

<div class="viewcode-block" id="get_motifs_per_TF"><a class="viewcode-back" href="../../api.html#pycistarget.utils.get_motifs_per_TF">[docs]</a><span class="k">def</span> <span class="nf">get_motifs_per_TF</span><span class="p">(</span><span class="n">motif_enrichment_table</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
                    <span class="n">tf</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                    <span class="n">motif_column</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                    <span class="n">annotation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Orthology_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_and_Orthology_annot&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get motif annotated to each TF from a motif enrichment table</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">motifs</span><span class="o">=</span> <span class="p">[]</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;\(&#39;</span><span class="p">)</span>
    <span class="n">tf</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;\)&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">motif_enrichment_table</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">motif_column</span> <span class="o">!=</span> <span class="s1">&#39;Index&#39;</span><span class="p">:</span>
                    <span class="n">motifs</span> <span class="o">=</span> <span class="n">motifs</span> <span class="o">+</span> <span class="n">motif_enrichment_table</span><span class="p">[</span><span class="n">motif_enrichment_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">tf</span><span class="o">+</span><span class="s1">&#39;,|&#39;</span><span class="o">+</span><span class="n">tf</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)][</span><span class="n">motif_column</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">motifs</span> <span class="o">=</span> <span class="n">motifs</span> <span class="o">+</span> <span class="n">motif_enrichment_table</span><span class="p">[</span><span class="n">motif_enrichment_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">tf</span><span class="o">+</span><span class="s1">&#39;,|&#39;</span><span class="o">+</span><span class="n">tf</span><span class="o">+</span><span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">na</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">motifs</span><span class="p">))</span></div>
        
<div class="viewcode-block" id="get_cistrome_per_TF"><a class="viewcode-back" href="../../api.html#pycistarget.utils.get_cistrome_per_TF">[docs]</a><span class="k">def</span> <span class="nf">get_cistrome_per_TF</span><span class="p">(</span><span class="n">motif_hits_dict</span><span class="p">,</span>
                       <span class="n">motifs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format cistromes per TF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">sum</span><span class="p">([</span><span class="n">motif_hits_dict</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">motifs</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">motif_hits_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()],[])))</span></div>
    
<div class="viewcode-block" id="inplace_change"><a class="viewcode-back" href="../../api.html#pycistarget.utils.inplace_change">[docs]</a><span class="k">def</span> <span class="nf">inplace_change</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">old_string</span><span class="p">,</span> <span class="n">new_string</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace string in a file</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Safely read the input filename using &#39;with&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">old_string</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="k">return</span>
    <span class="c1"># Safely write the changed content, if found in the file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_string</span><span class="p">,</span> <span class="n">new_string</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="get_position_index"><a class="viewcode-back" href="../../api.html#pycistarget.utils.get_position_index">[docs]</a><span class="k">def</span> <span class="nf">get_position_index</span><span class="p">(</span><span class="n">query_list</span><span class="p">,</span> <span class="n">target_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get position of a query within a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">target_list</span><span class="p">)}</span>
    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">query_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="target_to_query"><a class="viewcode-back" href="../../api.html#pycistarget.utils.target_to_query">[docs]</a><span class="k">def</span> <span class="nf">target_to_query</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
         <span class="n">query</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
         <span class="n">fraction_overlap</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Map query regions to another set of regions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#Read input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">target_pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">target_pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">region_names_to_coordinates</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">):</span>
        <span class="n">target_pr</span><span class="o">=</span><span class="n">target</span>
    <span class="c1"># Read input</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">query_pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">query_pr</span><span class="o">=</span><span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">(</span><span class="n">region_names_to_coordinates</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">pr</span><span class="o">.</span><span class="n">PyRanges</span><span class="p">):</span>
        <span class="n">query_pr</span><span class="o">=</span><span class="n">query</span>
    
    <span class="n">join_pr</span> <span class="o">=</span> <span class="n">target_pr</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">query_pr</span><span class="p">,</span> <span class="n">report_overlap</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap_query</span> <span class="o">=</span>  <span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap</span><span class="o">/</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">End_b</span> <span class="o">-</span> <span class="n">join_pr</span><span class="o">.</span><span class="n">Start_b</span><span class="p">)</span>
    <span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap_target</span> <span class="o">=</span>  <span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap</span><span class="o">/</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">End</span> <span class="o">-</span> <span class="n">join_pr</span><span class="o">.</span><span class="n">Start</span><span class="p">)</span>
    <span class="n">join_pr</span> <span class="o">=</span> <span class="n">join_pr</span><span class="p">[(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap_query</span> <span class="o">&gt;</span> <span class="n">fraction_overlap</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Overlap_target</span> <span class="o">&gt;</span> <span class="n">fraction_overlap</span><span class="p">)]</span>
    <span class="n">target_regions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Chromosome</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Start</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">End</span><span class="p">))]</span>
    <span class="n">query_regions</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">chrom</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Chromosome</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">Start_b</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">join_pr</span><span class="o">.</span><span class="n">End_b</span><span class="p">))]</span>
    <span class="n">target_to_query</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">target_regions</span><span class="p">,</span> <span class="n">query_regions</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Target&#39;</span><span class="p">,</span> <span class="s1">&#39;Query&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="k">return</span> <span class="n">target_to_query</span></div>
    
<div class="viewcode-block" id="get_cistromes_per_region_set"><a class="viewcode-back" href="../../api.html#pycistarget.utils.get_cistromes_per_region_set">[docs]</a><span class="k">def</span> <span class="nf">get_cistromes_per_region_set</span><span class="p">(</span><span class="n">motif_enrichment_region_set</span><span class="p">,</span>
                  <span class="n">motif_hits_regions_set</span><span class="p">,</span>
                  <span class="n">annotation</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Orthology_annot&#39;</span><span class="p">,</span> <span class="s1">&#39;Motif_similarity_and_Orthology_annot&#39;</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get (direct/extended) cistromes for TFs</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;Direct_annot&#39;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">tfs</span> <span class="o">=</span> <span class="n">get_TF_list</span><span class="p">(</span><span class="n">motif_enrichment_region_set</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">])</span>
        <span class="n">cistromes_per_region_set_direct</span> <span class="o">=</span> <span class="p">{</span><span class="n">tf</span> <span class="p">:</span> <span class="n">get_cistrome_per_TF</span><span class="p">(</span><span class="n">motif_hits_regions_set</span><span class="p">,</span> 
                                                            <span class="n">get_motifs_per_TF</span><span class="p">(</span><span class="n">motif_enrichment_region_set</span><span class="p">,</span>
                                                                           <span class="n">tf</span><span class="p">,</span>
                                                                           <span class="n">motif_column</span> <span class="o">=</span> <span class="s1">&#39;Index&#39;</span><span class="p">,</span>
                                                                           <span class="n">annotation</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Direct_annot&#39;</span><span class="p">]))</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tfs</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cistromes_per_region_set_direct</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;Direct_annot&#39;</span> <span class="ow">in</span> <span class="n">annotation</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">tfs</span> <span class="o">=</span> <span class="n">get_TF_list</span><span class="p">(</span><span class="n">motif_enrichment_region_set</span><span class="p">)</span>
        <span class="n">cistromes_per_region_set_extended</span> <span class="o">=</span> <span class="p">{</span><span class="n">tf</span><span class="o">+</span><span class="s1">&#39;_extended&#39;</span><span class="p">:</span> <span class="n">get_cistrome_per_TF</span><span class="p">(</span><span class="n">motif_hits_regions_set</span><span class="p">,</span> 
                                                            <span class="n">get_motifs_per_TF</span><span class="p">(</span><span class="n">motif_enrichment_region_set</span><span class="p">,</span>
                                                                           <span class="n">tf</span><span class="p">,</span>
                                                                           <span class="n">motif_column</span> <span class="o">=</span> <span class="s1">&#39;Index&#39;</span><span class="p">,</span>
                                                                           <span class="n">annotation</span><span class="o">=</span><span class="n">annotation</span><span class="p">))</span> <span class="k">for</span> <span class="n">tf</span> <span class="ow">in</span> <span class="n">tfs</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cistromes_per_region_set_extended</span><span class="o">=</span><span class="p">{}</span>
    
    <span class="n">cistromes_per_region_set</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">cistromes_per_region_set_direct</span><span class="p">,</span> <span class="o">**</span><span class="n">cistromes_per_region_set_extended</span><span class="p">}</span>
    <span class="n">cistromes_per_region_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span> <span class="o">+</span> <span class="s1">&#39;_(&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cistromes_per_region_set</span><span class="p">[</span><span class="n">x</span><span class="p">]))</span> <span class="o">+</span> <span class="s1">&#39;r)&#39;</span><span class="p">:</span> <span class="n">cistromes_per_region_set</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cistromes_per_region_set</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
    <span class="k">return</span> <span class="n">cistromes_per_region_set</span></div>

<span class="k">def</span> <span class="nf">is_iterable_not_string</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Carmen Bravo Gonzalez Blas, Seppe de Winter.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>